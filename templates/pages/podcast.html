{% extends 'base.html' %}

{% block title %}AI Podcast Generator - LearnAI{% endblock %}

{% block content %}
<section class="podcast-section">
    <div class="container">
        <!-- Header -->
        <div class="section-header">
            <h1>AI <span class="text-gradient">Podcast</span> Generator</h1>
            <p>Transform your study materials into engaging audio podcasts with two AI hosts discussing your topics.</p>
        </div>

        <div class="podcast-layout">
            <!-- Left Panel: Documents & Settings -->
            <div class="podcast-left-panel">
                <!-- Document Selection -->
                <div class="panel-card">
                    <h3>Select Document</h3>
                    <div id="documentsList">
                        {% for doc in documents %}
                        <div class="document-item" data-id="{{ doc.id }}">
                            <div class="doc-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                    <polyline points="14,2 14,8 20,8" />
                                </svg>
                            </div>
                            <div class="doc-info">
                                <span class="doc-title">{{ doc.title }}</span>
                                <span class="doc-meta">{{ doc.page_count }} pages</span>
                            </div>
                            <button class="btn-icon select-doc" title="Select">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M5 12h14M12 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                        {% empty %}
                        <p class="no-documents">No documents yet. <a href="{% url 'summaries' %}">Upload one first</a>!
                        </p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Recent Podcasts -->
                {% if recent_podcasts %}
                <div class="panel-card">
                    <h3>Recent Podcasts</h3>
                    <div class="recent-list">
                        {% for podcast in recent_podcasts %}
                        <div class="recent-item">
                            <div class="recent-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                                    <line x1="12" y1="19" x2="12" y2="23" />
                                    <line x1="8" y1="23" x2="16" y2="23" />
                                </svg>
                            </div>
                            <div class="recent-info">
                                <span class="recent-title">{{ podcast.title }}</span>
                                <span class="recent-meta">{{ podcast.level_label }}</span>
                            </div>
                            {% if podcast.audio_file %}
                            <a href="{% url 'view_podcast' podcast.id %}" class="btn-icon" title="View Podcast">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M5 12h14M12 5l7 7-7 7" />
                                </svg>
                            </a>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Right Panel: Generator -->
            <div class="podcast-right-panel">
                <!-- Selected Document State -->
                <div class="generator-card" id="generatorCard" style="display: none;">
                    <div class="selected-doc-header">
                        <div class="selected-doc-info">
                            <h3 id="selectedDocTitle">Document Title</h3>
                            <span class="selected-doc-meta" id="selectedDocMeta"></span>
                        </div>
                    </div>

                    <!-- Level Selection -->
                    <div class="level-selector">
                        <label>Podcast Depth Level:</label>
                        <div class="level-cards">
                            <button class="level-card active" data-level="beginner">
                                <span class="level-emoji">ðŸŸ¢</span>
                                <span class="level-name">Beginner</span>
                                <span class="level-desc">Simple explanations, analogies, big-picture overview</span>
                            </button>
                            <button class="level-card" data-level="intermediate">
                                <span class="level-emoji">ðŸŸ¡</span>
                                <span class="level-name">Intermediate</span>
                                <span class="level-desc">Deeper concepts, relationships, practical applications</span>
                            </button>
                            <button class="level-card" data-level="advanced">
                                <span class="level-emoji">ðŸ”´</span>
                                <span class="level-name">Advanced</span>
                                <span class="level-desc">Nuances, critical analysis, expert-level discussion</span>
                            </button>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-generate" id="generateBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                            <line x1="12" y1="19" x2="12" y2="23" />
                            <line x1="8" y1="23" x2="16" y2="23" />
                        </svg>
                        Generate Podcast
                    </button>
                </div>

                <!-- Result Section -->
                <div class="podcast-result" id="podcastResult" style="display: none;">
                    <div class="result-success-card">
                        <div class="result-check">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                                <polyline points="22 4 12 14.01 9 11.01" />
                            </svg>
                        </div>
                        <h3 id="resultTitle">Podcast Generated!</h3>
                        <p class="result-meta" id="resultMeta"></p>
                        <div class="result-actions">
                            <a class="btn btn-primary btn-lg" id="viewPodcastBtn" href="#">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polygon points="5 3 19 12 5 21 5 3" />
                                </svg>
                                View & Listen to Podcast
                            </a>
                            <button class="btn btn-outline" id="generateAnotherBtn">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <circle cx="12" cy="12" r="10" />
                                    <line x1="12" y1="8" x2="12" y2="16" />
                                    <line x1="8" y1="12" x2="16" y2="12" />
                                </svg>
                                Generate Another
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="emptyState">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="1.5">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                        <line x1="12" y1="19" x2="12" y2="23" />
                        <line x1="8" y1="23" x2="16" y2="23" />
                    </svg>
                    <h3>Create Your Podcast</h3>
                    <p>Select a document and choose a depth level to generate an AI-powered podcast</p>
                </div>

                <!-- Loading State -->
                <div class="loading-state" id="loadingState" style="display: none;">
                    <div class="podcast-loading">
                        <div class="loading-mic">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                                <line x1="12" y1="19" x2="12" y2="23" />
                                <line x1="8" y1="23" x2="16" y2="23" />
                            </svg>
                        </div>
                        <div class="loading-waves">
                            <span></span><span></span><span></span><span></span><span></span>
                        </div>
                    </div>
                    <h3>Generating Your Podcast...</h3>
                    <p id="loadingStatus">Creating script with two AI hosts...</p>
                    <p class="loading-hint">This may take a minute â€” we're writing the script and converting it to audio
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_css %}
<style>
    .podcast-section {
        padding: 7rem 0 4rem;
        min-height: 100vh;
    }

    .section-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .section-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .section-header p {
        color: var(--text-secondary);
        max-width: 600px;
        margin: 0 auto;
    }

    .podcast-layout {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 2rem;
        align-items: start;
    }

    /* Left Panel */
    .podcast-left-panel {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .panel-card {
        background: var(--gradient-card);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
    }

    .panel-card h3 {
        margin-bottom: 1rem;
        font-size: 1rem;
    }

    .document-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .document-item:hover,
    .document-item.selected {
        background: var(--bg-tertiary);
    }

    .document-item.selected {
        border-left: 3px solid var(--accent-primary);
    }

    .doc-icon {
        color: var(--accent-primary);
        flex-shrink: 0;
    }

    .doc-info {
        flex-grow: 1;
        min-width: 0;
    }

    .doc-title {
        display: block;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .doc-meta {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    .btn-icon {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: var(--radius-sm);
        transition: all var(--transition-fast);
        text-decoration: none;
    }

    .btn-icon:hover {
        color: var(--accent-primary);
        background: var(--bg-tertiary);
    }

    .no-documents {
        text-align: center;
        color: var(--text-secondary);
        padding: 1rem;
    }

    .no-documents a {
        color: var(--accent-primary);
    }

    /* Recent Podcasts */
    .recent-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.6rem;
        border-radius: var(--radius-md);
        transition: background var(--transition-fast);
    }

    .recent-item:hover {
        background: var(--bg-tertiary);
    }

    .recent-icon {
        color: var(--accent-secondary, #a78bfa);
        flex-shrink: 0;
    }

    .recent-info {
        flex-grow: 1;
        min-width: 0;
    }

    .recent-title {
        display: block;
        font-weight: 500;
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .recent-meta {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    /* Right Panel */
    .podcast-right-panel {
        min-height: 500px;
    }

    .generator-card {
        background: var(--gradient-card);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-bottom: 1.5rem;
    }

    .selected-doc-header {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--glass-border);
    }

    .selected-doc-header h3 {
        margin-bottom: 0.25rem;
    }

    .selected-doc-meta {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    /* Level Cards */
    .level-selector {
        margin-bottom: 1.5rem;
    }

    .level-selector label {
        display: block;
        margin-bottom: 0.75rem;
        font-weight: 500;
    }

    .level-cards {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
    }

    .level-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        padding: 1rem 0.5rem;
        background: var(--bg-tertiary);
        border: 2px solid var(--glass-border);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all var(--transition-fast);
        text-align: center;
        color: var(--text-primary);
    }

    .level-card:hover {
        border-color: var(--accent-primary);
        transform: translateY(-2px);
    }

    .level-card.active {
        border-color: var(--accent-primary);
        background: linear-gradient(135deg, rgba(0, 217, 192, 0.1) 0%, rgba(0, 143, 122, 0.05) 100%);
        box-shadow: 0 0 20px rgba(0, 217, 192, 0.1);
    }

    .level-emoji {
        font-size: 1.5rem;
    }

    .level-name {
        font-weight: 600;
        font-size: 0.9rem;
    }

    .level-desc {
        font-size: 0.7rem;
        color: var(--text-secondary);
        line-height: 1.3;
    }

    .btn-generate {
        width: 100%;
        justify-content: center;
        gap: 0.5rem;
        font-size: 1rem;
        padding: 0.875rem 1.5rem;
    }

    /* Result Success Card */
    .podcast-result {
        animation: fadeIn 0.4s ease;
    }

    .result-success-card {
        background: var(--gradient-card);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-lg);
        padding: 3rem;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    .result-check {
        color: var(--accent-primary);
        animation: checkPop 0.5s ease;
    }

    @keyframes checkPop {
        0% {
            transform: scale(0);
            opacity: 0;
        }

        50% {
            transform: scale(1.2);
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    .result-success-card h3 {
        color: var(--accent-primary);
        font-size: 1.5rem;
        margin: 0;
    }

    .result-meta {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin: 0;
    }

    .result-actions {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        width: 100%;
        max-width: 320px;
        margin-top: 0.5rem;
    }

    .result-actions .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        text-decoration: none;
        width: 100%;
    }

    .btn-lg {
        padding: 0.875rem 1.5rem;
        font-size: 1rem;
    }

    /* Empty State */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        background: var(--gradient-card);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-lg);
        padding: 3rem;
        min-height: 400px;
        color: var(--text-secondary);
    }

    .empty-state svg {
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-state h3 {
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    /* Loading State */
    .loading-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        background: var(--gradient-card);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-lg);
        padding: 3rem;
        min-height: 400px;
    }

    .podcast-loading {
        margin-bottom: 1.5rem;
    }

    .loading-mic {
        color: var(--accent-primary);
        animation: pulse 1.5s infinite;
        margin-bottom: 0.75rem;
    }

    .loading-waves {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
    }

    .loading-waves span {
        display: block;
        width: 4px;
        height: 20px;
        background: var(--accent-primary);
        border-radius: 2px;
        animation: wave 1s ease-in-out infinite;
    }

    .loading-waves span:nth-child(2) {
        animation-delay: 0.1s;
    }

    .loading-waves span:nth-child(3) {
        animation-delay: 0.2s;
    }

    .loading-waves span:nth-child(4) {
        animation-delay: 0.3s;
    }

    .loading-waves span:nth-child(5) {
        animation-delay: 0.4s;
    }

    @keyframes wave {

        0%,
        100% {
            transform: scaleY(0.5);
        }

        50% {
            transform: scaleY(1.5);
        }
    }

    .loading-state h3 {
        margin-bottom: 0.5rem;
    }

    .loading-state p {
        color: var(--text-secondary);
        margin: 0;
    }

    .loading-hint {
        font-size: 0.8rem;
        margin-top: 0.5rem !important;
        opacity: 0.7;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Responsive */
    @media (max-width: 992px) {
        .podcast-layout {
            grid-template-columns: 1fr;
        }

        .level-cards {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const generatorCard = document.getElementById('generatorCard');
        const selectedDocTitle = document.getElementById('selectedDocTitle');
        const selectedDocMeta = document.getElementById('selectedDocMeta');
        const emptyState = document.getElementById('emptyState');
        const loadingState = document.getElementById('loadingState');
        const loadingStatus = document.getElementById('loadingStatus');
        const podcastResult = document.getElementById('podcastResult');
        const generateBtn = document.getElementById('generateBtn');
        const viewPodcastBtn = document.getElementById('viewPodcastBtn');
        const generateAnotherBtn = document.getElementById('generateAnotherBtn');
        const resultTitle = document.getElementById('resultTitle');
        const resultMeta = document.getElementById('resultMeta');
        const levelCards = document.querySelectorAll('.level-card');

        let currentDocId = null;
        let currentLevel = 'beginner';

        // Document selection
        document.querySelectorAll('.document-item').forEach(item => {
            item.addEventListener('click', function () {
                const id = this.dataset.id;
                const title = this.querySelector('.doc-title').textContent;
                const meta = this.querySelector('.doc-meta').textContent;
                selectDocument(id, title, meta);
            });
        });

        function selectDocument(id, title, meta) {
            currentDocId = id;

            document.querySelectorAll('.document-item').forEach(el => {
                el.classList.toggle('selected', el.dataset.id === id);
            });

            selectedDocTitle.textContent = title;
            selectedDocMeta.textContent = meta;

            emptyState.style.display = 'none';
            generatorCard.style.display = 'block';
            podcastResult.style.display = 'none';
        }

        // Level selection
        levelCards.forEach(card => {
            card.addEventListener('click', function () {
                levelCards.forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                currentLevel = this.dataset.level;
            });
        });

        // Generate podcast
        generateBtn.addEventListener('click', async function () {
            if (!currentDocId) return;

            generatorCard.style.display = 'none';
            podcastResult.style.display = 'none';
            loadingState.style.display = 'flex';

            // Animate loading messages
            const loadingMessages = [
                'Creating script with two AI hosts...',
                'Alex and Sam are preparing their notes...',
                'Converting dialogue to natural speech...',
                'Stitching audio segments together...',
                'Almost there! Finalizing your podcast...'
            ];
            let msgIndex = 0;
            const msgInterval = setInterval(() => {
                msgIndex = (msgIndex + 1) % loadingMessages.length;
                loadingStatus.textContent = loadingMessages[msgIndex];
            }, 5000);

            try {
                const response = await fetch('{% url "generate_podcast" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        document_id: currentDocId,
                        level: currentLevel
                    })
                });

                clearInterval(msgInterval);
                const result = await response.json();
                loadingState.style.display = 'none';

                if (result.success) {
                    // Show success card with redirect button
                    resultTitle.textContent = result.podcast.title;
                    resultMeta.textContent = `${result.podcast.level} level â€¢ ${result.podcast.duration} â€¢ Generated in ${result.podcast.generation_time}s`;

                    viewPodcastBtn.href = result.podcast.view_url;

                    podcastResult.style.display = 'block';
                    generatorCard.style.display = 'block';
                } else {
                    alert('Error: ' + result.error);
                    generatorCard.style.display = 'block';
                }
            } catch (error) {
                clearInterval(msgInterval);
                loadingState.style.display = 'none';
                generatorCard.style.display = 'block';
                alert('Failed to generate podcast: ' + error.message);
            }
        });

        // Generate Another button
        generateAnotherBtn.addEventListener('click', function () {
            podcastResult.style.display = 'none';
            generatorCard.style.display = 'block';
        });
    });
</script>
{% endblock %}