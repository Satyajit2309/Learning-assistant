{% extends 'base.html' %}

{% block title %}Study Flashcards - LearnAI{% endblock %}

{% block content %}
<section class="study-section">
    <div class="container">
        <!-- Header -->
        <div class="study-header">
            <a href="{% url 'flashcards' %}" class="back-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                </svg>
                Back to Flashcards
            </a>
            <div class="header-info">
                <h1>{{ flashcard_set.title }}</h1>
                <p><span id="totalCards">{{ flashcard_set.card_count }}</span> cards</p>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-bar-large">
                <div class="progress-fill-large" id="progressFill"
                    style="width: {{ flashcard_set.progress_percentage }}%"></div>
            </div>
            <div class="progress-stats">
                <span class="current-card">Card <span id="currentCardNum">1</span> of <span id="totalCardsNav">{{
                        flashcard_set.card_count }}</span></span>
                <span class="mastered-count"><span id="masteredCount">{{ flashcard_set.cards_mastered }}</span>
                    mastered</span>
            </div>
        </div>

        <!-- Flashcard Area -->
        <div class="flashcard-area">
            <button class="nav-btn prev-btn" id="prevBtn" disabled>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6" />
                </svg>
            </button>

            <div class="card-container" id="cardContainer">
                <div class="flashcard" id="flashcard">
                    <div class="card-inner" id="cardInner">
                        <div class="card-face card-front">
                            <div class="card-priority" id="cardPriority">
                                <span class="priority-dot"></span>
                                <span class="priority-text">Important</span>
                            </div>
                            <div class="card-content" id="cardFront">
                                Loading...
                            </div>
                            <div class="flip-hint">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polyline points="17 1 21 5 17 9" />
                                    <path d="M3 11V9a4 4 0 0 1 4-4h14" />
                                    <polyline points="7 23 3 19 7 15" />
                                    <path d="M21 13v2a4 4 0 0 1-4 4H3" />
                                </svg>
                                Click to flip
                            </div>
                        </div>
                        <div class="card-face card-back">
                            <div class="card-label">Answer</div>
                            <div class="card-content" id="cardBack">
                                Loading...
                            </div>
                            <div class="flip-hint">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polyline points="17 1 21 5 17 9" />
                                    <path d="M3 11V9a4 4 0 0 1 4-4h14" />
                                    <polyline points="7 23 3 19 7 15" />
                                    <path d="M21 13v2a4 4 0 0 1-4 4H3" />
                                </svg>
                                Click to flip back
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="nav-btn next-btn" id="nextBtn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6" />
                </svg>
            </button>
        </div>

        <!-- Card Actions -->
        <div class="card-actions">
            <button class="action-btn mastery-btn" id="masteryBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                    <polyline points="22 4 12 14.01 9 11.01" />
                </svg>
                <span id="masteryText">Mark as Mastered</span>
            </button>
        </div>

        <!-- Card Dots -->
        <div class="card-dots" id="cardDots">
            <!-- Dots generated via JS -->
        </div>

        <!-- Keyboard Hints -->
        <div class="keyboard-hints">
            <span><kbd>←</kbd> Previous</span>
            <span><kbd>Space</kbd> Flip</span>
            <span><kbd>→</kbd> Next</span>
            <span><kbd>M</kbd> Toggle Mastered</span>
        </div>
    </div>
</section>

<!-- Hidden data element for cards -->
<script id="cardsData" type="application/json">{{ cards_json|safe }}</script>
{% endblock %}

{% block extra_css %}
<style>
    .study-section {
        padding: 6rem 0 4rem;
        min-height: 100vh;
    }

    /* Header */
    .study-header {
        margin-bottom: 2rem;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.9rem;
        margin-bottom: 1rem;
        transition: color var(--transition-fast);
    }

    .back-link:hover {
        color: var(--accent-primary);
    }

    .header-info h1 {
        font-size: 1.75rem;
        margin-bottom: 0.25rem;
    }

    .header-info p {
        color: var(--text-secondary);
        font-size: 0.95rem;
    }

    /* Progress Bar */
    .progress-container {
        margin-bottom: 2rem;
    }

    .progress-bar-large {
        height: 8px;
        background: var(--bg-tertiary);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 0.75rem;
    }

    .progress-fill-large {
        height: 100%;
        background: var(--gradient-primary);
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .progress-stats {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .mastered-count {
        color: var(--accent-primary);
        font-weight: 500;
    }

    /* Flashcard Area */
    .flashcard-area {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 2rem;
        min-height: 400px;
    }

    .nav-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--gradient-card);
        border: 1px solid var(--glass-border);
        color: var(--text-primary);
        cursor: pointer;
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .nav-btn:hover:not(:disabled) {
        border-color: var(--accent-primary);
        color: var(--accent-primary);
        transform: scale(1.1);
    }

    .nav-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    /* Card Container */
    .card-container {
        perspective: 1500px;
        width: 100%;
        max-width: 600px;
    }

    .flashcard {
        width: 100%;
        height: 350px;
        cursor: pointer;
    }

    .card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        transform-style: preserve-3d;
    }

    .flashcard.flipped .card-inner {
        transform: rotateY(180deg);
    }

    .card-face {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        background: var(--gradient-card);
        border: 2px solid var(--glass-border);
        border-radius: var(--radius-lg);
        padding: 2rem;
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-lg);
    }

    .card-front {
        border-color: var(--accent-primary);
        box-shadow: var(--shadow-lg), var(--shadow-glow);
    }

    .card-back {
        transform: rotateY(180deg);
        border-color: var(--accent-secondary);
        background: linear-gradient(145deg, rgba(0, 217, 192, 0.1) 0%, rgba(26, 26, 37, 0.9) 100%);
    }

    .card-priority {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    .priority-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--accent-primary);
    }

    .priority-dot.priority-1 {
        background: #ef4444;
    }

    .priority-dot.priority-2 {
        background: #f97316;
    }

    .priority-dot.priority-3 {
        background: #00d9c0;
    }

    .priority-dot.priority-4 {
        background: #22c55e;
    }

    .priority-dot.priority-5 {
        background: #6b7280;
    }

    .card-label {
        font-size: 0.8rem;
        color: var(--accent-primary);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 1rem;
    }

    .card-content {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: 1.25rem;
        line-height: 1.6;
        overflow-y: auto;
    }

    .flip-hint {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 1rem;
    }

    /* Card Actions */
    .card-actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .action-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background: var(--bg-tertiary);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all var(--transition-fast);
        font-size: 0.9rem;
    }

    .action-btn:hover {
        border-color: var(--accent-primary);
        color: var(--accent-primary);
    }

    .mastery-btn.mastered {
        background: rgba(0, 217, 192, 0.15);
        border-color: var(--accent-primary);
        color: var(--accent-primary);
    }

    /* Card Dots */
    .card-dots {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        max-width: 600px;
        margin: 0 auto 2rem;
    }

    .card-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--bg-tertiary);
        border: 1px solid var(--glass-border);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .card-dot.active {
        background: var(--accent-primary);
        border-color: var(--accent-primary);
        transform: scale(1.3);
    }

    .card-dot.mastered {
        background: rgba(34, 197, 94, 0.5);
        border-color: #22c55e;
    }

    .card-dot:hover {
        transform: scale(1.3);
    }

    /* Keyboard Hints */
    .keyboard-hints {
        display: flex;
        justify-content: center;
        gap: 2rem;
        color: var(--text-muted);
        font-size: 0.8rem;
    }

    .keyboard-hints kbd {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        background: var(--bg-tertiary);
        border: 1px solid var(--glass-border);
        border-radius: 4px;
        font-family: monospace;
        margin-right: 0.25rem;
    }

    /* Animations */
    @keyframes cardEnter {
        from {
            opacity: 0;
            transform: translateX(50px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes cardExit {
        from {
            opacity: 1;
            transform: translateX(0);
        }

        to {
            opacity: 0;
            transform: translateX(-50px);
        }
    }

    .card-enter {
        animation: cardEnter 0.3s ease forwards;
    }

    .card-exit {
        animation: cardExit 0.3s ease forwards;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .flashcard-area {
            flex-direction: column;
            gap: 1rem;
        }

        .nav-btn {
            display: none;
        }

        .flashcard {
            height: 300px;
        }

        .card-content {
            font-size: 1.1rem;
        }

        .keyboard-hints {
            display: none;
        }

        .card-actions {
            flex-direction: column;
            gap: 0.75rem;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Parse cards data from hidden script element
        const cardsDataElement = document.getElementById('cardsData');
        let cards = [];

        try {
            cards = JSON.parse(cardsDataElement.textContent);
        } catch (e) {
            console.error('Failed to parse cards data:', e);
            return;
        }

        if (!cards || cards.length === 0) {
            console.error('No cards data available');
            return;
        }

        let currentIndex = 0;
        let isFlipped = false;

        const flashcard = document.getElementById('flashcard');
        const cardFront = document.getElementById('cardFront');
        const cardBack = document.getElementById('cardBack');
        const cardPriority = document.getElementById('cardPriority');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const masteryBtn = document.getElementById('masteryBtn');
        const masteryText = document.getElementById('masteryText');
        const currentCardNum = document.getElementById('currentCardNum');
        const masteredCount = document.getElementById('masteredCount');
        const progressFill = document.getElementById('progressFill');
        const cardDots = document.getElementById('cardDots');
        const totalCardsNav = document.getElementById('totalCardsNav');

        // Update total cards display
        if (totalCardsNav) {
            totalCardsNav.textContent = cards.length;
        }

        // Priority labels
        const priorityLabels = {
            1: 'Critical',
            2: 'Very Important',
            3: 'Important',
            4: 'Helpful',
            5: 'Supplementary'
        };

        // Initialize dots
        function initDots() {
            cardDots.innerHTML = '';
            cards.forEach(function (card, index) {
                const dot = document.createElement('div');
                dot.className = 'card-dot' + (index === currentIndex ? ' active' : '') + (card.is_mastered ? ' mastered' : '');
                dot.addEventListener('click', function () {
                    goToCard(index);
                });
                cardDots.appendChild(dot);
            });
        }

        // Update dot states
        function updateDots() {
            const dots = cardDots.querySelectorAll('.card-dot');
            dots.forEach(function (dot, index) {
                dot.classList.toggle('active', index === currentIndex);
                dot.classList.toggle('mastered', cards[index].is_mastered);
            });
        }

        // Display current card
        function displayCard() {
            const card = cards[currentIndex];

            // Reset flip state
            isFlipped = false;
            flashcard.classList.remove('flipped');

            // Update content
            cardFront.textContent = card.front;
            cardBack.textContent = card.back;

            // Update priority
            const priorityDot = cardPriority.querySelector('.priority-dot');
            const priorityTextEl = cardPriority.querySelector('.priority-text');
            priorityDot.className = 'priority-dot priority-' + card.priority;
            priorityTextEl.textContent = priorityLabels[card.priority] || 'Important';

            // Update mastery button
            if (card.is_mastered) {
                masteryBtn.classList.add('mastered');
                masteryText.textContent = 'Mastered';
            } else {
                masteryBtn.classList.remove('mastered');
                masteryText.textContent = 'Mark as Mastered';
            }

            // Update navigation
            currentCardNum.textContent = currentIndex + 1;
            prevBtn.disabled = currentIndex === 0;
            nextBtn.disabled = currentIndex === cards.length - 1;

            // Update dots
            updateDots();
        }

        // Navigate to specific card
        function goToCard(index) {
            if (index < 0 || index >= cards.length) return;
            currentIndex = index;
            displayCard();
        }

        // Flip card
        function flipCard() {
            isFlipped = !isFlipped;
            flashcard.classList.toggle('flipped', isFlipped);
        }

        // Toggle mastery
        function toggleMastery() {
            const card = cards[currentIndex];
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            const csrfValue = csrfToken ? csrfToken.value : '{{ csrf_token }}';

            fetch('/api/flashcard/' + card.id + '/toggle-mastery/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfValue
                }
            })
                .then(function (response) {
                    return response.json();
                })
                .then(function (result) {
                    if (result.success) {
                        card.is_mastered = result.is_mastered;

                        // Update UI
                        if (card.is_mastered) {
                            masteryBtn.classList.add('mastered');
                            masteryText.textContent = 'Mastered';
                        } else {
                            masteryBtn.classList.remove('mastered');
                            masteryText.textContent = 'Mark as Mastered';
                        }

                        // Update progress
                        var mastered = cards.filter(function (c) { return c.is_mastered; }).length;
                        masteredCount.textContent = mastered;
                        progressFill.style.width = Math.round((mastered / cards.length) * 100) + '%';

                        updateDots();
                    }
                })
                .catch(function (error) {
                    console.error('Failed to toggle mastery:', error);
                });
        }

        // Event listeners
        flashcard.addEventListener('click', flipCard);
        prevBtn.addEventListener('click', function () { goToCard(currentIndex - 1); });
        nextBtn.addEventListener('click', function () { goToCard(currentIndex + 1); });
        masteryBtn.addEventListener('click', toggleMastery);

        // Keyboard controls
        document.addEventListener('keydown', function (e) {
            switch (e.key) {
                case 'ArrowLeft':
                    if (currentIndex > 0) goToCard(currentIndex - 1);
                    break;
                case 'ArrowRight':
                    if (currentIndex < cards.length - 1) goToCard(currentIndex + 1);
                    break;
                case ' ':
                    e.preventDefault();
                    flipCard();
                    break;
                case 'm':
                case 'M':
                    toggleMastery();
                    break;
            }
        });

        // Touch swipe support
        var touchStartX = 0;
        var touchEndX = 0;

        flashcard.addEventListener('touchstart', function (e) {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        flashcard.addEventListener('touchend', function (e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });

        function handleSwipe() {
            var swipeThreshold = 50;
            var diff = touchStartX - touchEndX;

            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0 && currentIndex < cards.length - 1) {
                    goToCard(currentIndex + 1);
                } else if (diff < 0 && currentIndex > 0) {
                    goToCard(currentIndex - 1);
                }
            }
        }

        // Initialize
        initDots();
        displayCard();
    });
</script>
{% csrf_token %}
{% endblock %}